# | This workflow can be invoked only from root workflow.
# | More information about Reusing workflows - https://docs.github.com/en/actions/using-workflows/reusing-workflows

name: "Reusable :: Report in issue"

on:
  workflow_call:
    inputs:
      # | Title for matching already existing comments in PR for update particular comment.
      report-msg-title:
        required: false
        type: string

      # | If we need publish available run artifacts list, separate workflow must be invoked as artifacts
      # | from current workflow run are not visible for API before run is completed.
      # | Related issue - https://github.com/actions/upload-artifact/issues/50
      # | If "publish-artifacts-list === false", comment won't contain artifacts list and will be published
      # | in current step.
      # | If "publish-artifacts-list === true", comment will contain artifacts list and will be published
      # | in dispatched workflow.
      publish-artifacts-list:
        required: true
        type: boolean

      app-storybook-build-pub-report:
        required: true
        type: boolean
      app-storybook-build-status:
        required: false
        type: boolean

      app-storybook-deploy-pub-report:
        required: true
        type: boolean
      app-storybook-deploy-status:
        required: false
        type: boolean

      app-unit-test-pub-report:
        required: true
        type: boolean
      app-unit-test-status:
        required: false
        type: boolean
      app-unit-test-codecov-percentage:
        required: false
        type: string
      app-unit-test-codecov-diff:
        required: false
        type: string

    secrets:
      gh_token:
        required: true
      # | Branch name which is configured as a root branch for GitHub Pages
      gh_pages_full_branch:
        required: true
      # | Custom domain for configured GitHub Pages, where App and Storybook builds are deployed. Must be passed
      # | as a secret because API doesn't receive this value.
      gh_pages_custom_domain:
        required: true

jobs:
  publish-report-issue-comment:
    name: "Publish comment"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Get Timestamp
        id: timestamp
        uses: nanzm/get-time-action@v1.1
        with:
          format: 'YYYYMMDDHHmmssSSS'

      - name: Cache issue comment content
        uses: actions/cache@v2
        id: cache-reporter-content
        env:
          TIMESTAMP: ${{ steps.timestamp.outputs.time }}
        with:
          path: ./reporter-artifacts
          key: reporter-artifacts-branch-${{ github.ref_name }}-commit-${{ github.sha }}-${{ steps.timestamp.outputs.time }}
          restore-keys: |
            reporter-artifacts-branch-${{ github.ref_name }}-commit-${{ github.sha }}-

      - name: "Check if comment data folder exists"
        id: check-cache-existance
        run: |
          DIR="./reporter-artifacts"
          if [ -d "$DIR" ]; then
            echo "::set-output name=cached-comment-data-exists::true"
          else
            echo "::set-output name=cached-comment-data-exists::false"
          fi

      - name: "Parse issue comment data from cache"
        id: parse-issue-comment-data
        if: steps.check-cache-existance.outputs.cached-comment-data-exists == 'true'
        run: |
          issueCommentDataJson=$(cat ./reporter-artifacts/issue-comment-data.json)
          issueCommentDataJson="${issueCommentDataJson//'%'/'%25'}"
          issueCommentDataJson="${issueCommentDataJson//$'\n'/'%0A'}"
          issueCommentDataJson="${issueCommentDataJson//$'\r'/'%0D'}"
          echo "::set-output name=issueCommentDataJson::$issueCommentDataJson"

      - run: mkdir -p reporter-artifacts
        if: steps.check-cache-existance.outputs.cached-comment-data-exists != 'true'

      - name: "Run github-script for preparation and publication comment content"
        uses: actions/github-script@v6
        id: issue-comment-data
        env:
          REPORT_MSG_TITLE: "Basilisk UI reporter"
          PUBLISH_ARTIFACTS_LIST: ${{inputs.publish-artifacts-list}}
          PUBLISH_ARTIFACTS_GROUP: ${{inputs.publish-artifacts-group}}
          # | Workflow file which will be dispatched from github-script via API for fetching and publication
          # | artifacts list from current workflow run if "PUBLISH_ARTIFACTS_LIST === true"
          PUBLISH_ARTIFACTS_WORKFLOW_DISPATCH_FILE: wfd_publish-issue-comment-with-artifacts.yml
          COMMENT_CACHED_CONTENT: ${{steps.parse-issue-comment-data.outputs.issueCommentDataJson || false}}

          IS_APP_STORYBOOK_BUILD_REPORT: ${{ inputs.app-storybook-build-pub-report }}
          IS_APP_UNIT_TEST_REPORT: ${{ inputs.app-unit-test-pub-report }}
          IS_APP_E2E_TEST_REPORT: false
          IS_STORYBOOK_UNIT_TEST_REPORT: false
          IS_STORYBOOK_E2E_TEST_REPORT: false
          IS_APP_STORYBOOK_DEPLOYMENT_REPORT: ${{ inputs.app-storybook-deploy-pub-report }}

          APP_UNIT_TEST_PERCENTAGE: ${{ inputs.app-unit-test-codecov-percentage }}
          APP_UNIT_TEST_DIFF: ${{ inputs.app-unit-test-codecov-diff }}
          APP_UNIT_TEST_STATUS: ${{ inputs.app-unit-test-status }}

          APP_STORYBOOK_BUILD_STATUS: ${{ inputs.app-storybook-build-status }}
          APP_STORYBOOK_DEPLOYMENT_STATUS: ${{ inputs.app-storybook-deploy-status }}

          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_PAGES_CUSTOM_DOMAIN: ${{ secrets.gh_pages_custom_domain }}

        with:
          script: |
            const script = require('./scripts/ci/github-script-src/publish-issue-comment.js')
            return await script({github, context, core})

      - name: Save issue comment prepared content into file
        run: |
          echo ${{ steps.issue-comment-data.outputs.result }} > ./reporter-artifacts/issue-comment-data.json

      - name: Upload test art
        uses: actions/upload-artifact@v2
        with:
          name: wf-maint-comment-data
          path: ./reporter-artifacts/issue-comment-data.json
